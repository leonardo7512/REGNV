<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar Nota de Venta - FUCAS SPA</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f5f5f5; color: #333; line-height: 1.6; }
        .container { max-width: 900px; margin: 20px auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #007bff, #0056b3); color: white; padding: 30px; border-radius: 10px; text-align: center; margin-bottom: 20px; }
        .header h1 { font-size: 2rem; margin-bottom: 10px; }
        .form-section { background: white; border-radius: 10px; padding: 30px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-group label { font-weight: 600; margin-bottom: 5px; color: #374151; }
        .form-group label.required::after { content: " *"; color: #ef4444; }
        .form-group input, .form-group select, .form-group textarea { padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 14px; transition: border-color 0.3s; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #007bff; box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1); }
        .form-group input:read-only { background-color: #e9ecef; cursor: not-allowed; }
        .form-group textarea { min-height: 80px; resize: vertical; }
        .btn { display: inline-block; width: 100%; padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; font-size: 16px; cursor: pointer; transition: all 0.3s; text-align: center; }
        .btn-primary { background-color: #28a745; color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #218838; }
        .btn:disabled { background-color: #cccccc; cursor: not-allowed; }
        .status-message { padding: 15px; border-radius: 8px; margin-top: 20px; text-align: center; display: none; }
        .status-message.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-message.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status-message.loading { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .file-input-group { background: #f8fafc; border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; }
        .preview-container { margin-top: 10px; border: 2px dashed #cbd5e1; min-height: 100px; padding: 10px; background-color: #fff; border-radius: 6px; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; }
        .preview-container img { display: block; max-width: 100%; max-height: 180px; height: auto; object-fit: contain; }
        .preview-container small { color: #666; }
        .remove-photo-btn { position: absolute; top: 5px; right: 5px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-weight: bold; cursor: pointer; display: none; align-items: center; justify-content: center; font-family: monospace; }
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .header h1 { font-size: 1.5rem; }
            .form-section { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Registro de Nota de Venta</h1>
            <p>Formulario para el ingreso de notas de venta y sus respaldos.</p>
        </div>

        <div class="form-section">
            <form id="nvForm" novalidate>
                <div class="form-group full-width" style="background-color: #eef7ff; padding: 15px; border-radius: 8px; margin-bottom: 25px;">
                    <label for="ejecutor" class="required">Tu Nombre (Ejecutor)</label>
                    <select id="ejecutor" required>
                        <option value="" disabled selected>-- Selecciona tu usuario --</option>
                        <option value="JFG">JFG</option>
                        <option value="LCT">LCT</option>
                        <option value="DMN">DMN</option>
                    </select>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label for="fechaNV" class="required">Fecha y Hora de Registro</label>
                        <input type="datetime-local" id="fechaNV" readonly>
                    </div>
                    <div class="form-group">
                        <label for="numeroNV" class="required">Número Nota Venta</label>
                        <input type="text" id="numeroNV" required>
                    </div>
                    <div class="form-group">
                        <label for="turnoNV" class="required">Turno</label>
                        <input type="text" id="turnoNV" required>
                    </div>
                    <div class="form-group">
                        <label for="vendedorNV" class="required">Vendedor</label>
                        <input type="text" id="vendedorNV" required>
                    </div>
                    <div class="form-group full-width">
                        <label for="statusNV" class="required">Status</label>
                        <select id="statusNV" required>
                            <option value="">-- Seleccione un Status --</option>
                            <option value="PAGADO">PAGADO</option>
                            <option value="POR PAGAR">POR PAGAR</option>
                            <option value="OTROS">OTROS</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label for="observacionesNV">Observaciones (Opcional)</label>
                        <textarea id="observacionesNV"></textarea>
                    </div>
                </div>

                <div style="margin-top: 30px; margin-bottom: 30px;">
                    <button type="submit" id="submitButton" class="btn btn-primary">Guardar Nota de Venta</button>
                </div>

                <h3 style="text-align: center; border-top: 1px solid #eee; padding-top: 20px; margin-bottom: 20px; color: #333;">Adjuntar Fotos</h3>
                
                <div class="form-grid" style="gap: 25px;">
                     <div class="form-group file-input-group">
                        <label for="photoNV1" class="required">Foto Nota de Venta 1</label>
                        <input type="file" id="photoNV1" accept="image/*" required>
                        <div id="previewNV1" class="preview-container">
                            <small>Previsualización Foto 1</small>
                            <button type="button" id="removePhotoNV1" class="remove-photo-btn" title="Quitar Foto 1">X</button>
                        </div>
                    </div>
                     <div class="form-group file-input-group">
                        <label for="photoNV2">Foto Nota de Venta 2 (Opcional)</label>
                        <input type="file" id="photoNV2" accept="image/*">
                        <div id="previewNV2" class="preview-container">
                            <small>Previsualización Foto 2</small>
                            <button type="button" id="removePhotoNV2" class="remove-photo-btn" title="Quitar Foto 2">X</button>
                        </div>
                    </div>
                     <div class="form-group file-input-group">
                        <label for="photoNV3">Foto Nota de Venta 3 (Opcional)</label>
                        <input type="file" id="photoNV3" accept="image/*">
                        <div id="previewNV3" class="preview-container">
                            <small>Previsualización Foto 3</small>
                            <button type="button" id="removePhotoNV3" class="remove-photo-btn" title="Quitar Foto 3">X</button>
                        </div>
                    </div>
                </div>
            </form>
            <div id="statusMessage" class="status-message"></div>
        </div>
    </div>

    <script>
        // --- CONFIGURACIÓN ---
        // ⚠️ ¡IMPORTANTE! REEMPLAZA ESTA URL CON LA URL DE TU PROPIA APLICACIÓN WEB DE GOOGLE APPS SCRIPT
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbw9bVNGdGxlai8W3sZz0wUy01RpU8DaZPfoMy_KRZkmXhDw7GoDwBiZj6dfPr4xdxw/exec';

        // --- ELEMENTOS DEL DOM ---
        const nvForm = document.getElementById('nvForm');
        const submitButton = document.getElementById('submitButton');
        const statusMessage = document.getElementById('statusMessage');

        const fileInputs = [
            { id: 'photoNV1', input: document.getElementById('photoNV1'), preview: document.getElementById('previewNV1'), removeBtn: document.getElementById('removePhotoNV1'), label: 'Foto 1' },
            { id: 'photoNV2', input: document.getElementById('photoNV2'), preview: document.getElementById('previewNV2'), removeBtn: document.getElementById('removePhotoNV2'), label: 'Foto 2' },
            { id: 'photoNV3', input: document.getElementById('photoNV3'), preview: document.getElementById('previewNV3'), removeBtn: document.getElementById('removePhotoNV3'), label: 'Foto 3' }
        ];

        // --- FUNCIONES DE UTILIDAD ---
        function showStatus(message, type = 'loading') {
            statusMessage.textContent = message;
            statusMessage.className = `status-message ${type}`;
            statusMessage.style.display = 'block';
        }

        function hideStatus() {
            statusMessage.style.display = 'none';
        }

        function toggleSubmitButton(disabled, text = 'Guardar Nota de Venta') {
            submitButton.disabled = disabled;
            submitButton.textContent = disabled ? 'Procesando...' : text;
        }

        function previewFile(fileConfig) {
            const { input, preview, removeBtn, label } = fileConfig;
            const file = input.files[0];
            
            removeBtn.style.display = file ? 'flex' : 'none';

            if (file) {
                preview.innerHTML = `<small>Cargando...</small><button type="button" id="remove${fileConfig.id}" class="remove-photo-btn" title="Quitar ${label}" style="display:flex;">X</button>`;
                const reader = new FileReader();
                reader.onload = e => {
                    preview.innerHTML = `<img src="${e.target.result}" alt="Previsualización"><button type="button" id="remove${fileConfig.id}" class="remove-photo-btn" title="Quitar ${label}" style="display:flex;">X</button>`;
                };
                reader.readAsDataURL(file);
            } else {
                preview.innerHTML = `<small>Previsualización ${label}</small><button type="button" id="remove${fileConfig.id}" class="remove-photo-btn" title="Quitar ${label}"></button>`;
            }
        }
        
        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                if (!file) return resolve(null); // Resuelve como null si no hay archivo
                const reader = new FileReader();
                reader.onload = (event) => {
                    if (event.target.readyState === FileReader.DONE && typeof event.target.result === 'string') {
                        const base64String = event.target.result.split(',')[1];
                        resolve({
                            fileName: file.name,
                            mimeType: file.type || 'application/octet-stream',
                            base64Data: base64String
                        });
                    } else {
                        reject(new Error(`Error al leer el archivo ${file.name}`));
                    }
                };
                reader.onerror = (error) => reject(new Error(`Error en FileReader: ${error.message}`));
                reader.readAsDataURL(file);
            });
        }

        // --- LÓGICA PRINCIPAL ---
        document.addEventListener('DOMContentLoaded', () => {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            const formattedDateTime = now.toISOString().slice(0, 16);
            document.getElementById('fechaNV').value = formattedDateTime;

            fileInputs.forEach(config => {
                config.input.addEventListener('change', () => previewFile(config));
                config.preview.addEventListener('click', (e) => {
                    if (e.target.classList.contains('remove-photo-btn')) {
                        config.input.value = '';
                        previewFile(config);
                    }
                });
            });
        });

        nvForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            hideStatus();

            if (WEB_APP_URL === 'URL_DE_TU_APLICACION_WEB_AQUI') {
                showStatus('Error: La URL de la aplicación web no ha sido configurada en el script.', 'error');
                return;
            }

            // Validación de campos
            const requiredFields = ['ejecutor', 'numeroNV', 'turnoNV', 'vendedorNV', 'statusNV', 'photoNV1'];
            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field.value) {
                    showStatus(`Error: El campo "${field.labels[0].textContent}" es obligatorio.`, 'error');
                    field.focus();
                    return;
                }
            }
            
            toggleSubmitButton(true);
            showStatus('Preparando y leyendo archivos...', 'loading');

            try {
                // Leer todos los archivos en paralelo
                const filePromises = fileInputs.map(config => readFileAsBase64(config.input.files[0]));
                const [photoResult1, photoResult2, photoResult3] = await Promise.all(filePromises);

                const formData = {
                    fechaNV: document.getElementById('fechaNV').value,
                    numeroNV: document.getElementById('numeroNV').value.trim(),
                    turnoNV: document.getElementById('turnoNV').value.trim(),
                    vendedorNV: document.getElementById('vendedorNV').value.trim(),
                    statusNV: document.getElementById('statusNV').value,
                    observacionesNV: document.getElementById('observacionesNV').value.trim(),
                    user: document.getElementById('ejecutor').value.trim(),
                    photoInfo1: photoResult1,
                    photoInfo2: photoResult2,
                    photoInfo3: photoResult3
                };

                showStatus('Enviando datos al servidor... Esto puede tardar un momento.', 'loading');

                // Enviar datos usando fetch
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'cors',
                    redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // Apps Script funciona mejor con text/plain para POST
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();

                if (result.status === 'success') {
                    showStatus(result.message || '¡Nota de Venta guardada con éxito!', 'success');
                    nvForm.reset();
                    fileInputs.forEach(previewFile); // Limpiar previsualizaciones
                } else {
                    throw new Error(result.message || 'Ocurrió un error desconocido en el servidor.');
                }

            } catch (error) {
                showStatus(`Error Crítico: ${error.message}`, 'error');
                console.error('Error en el proceso de envío:', error);
            } finally {
                toggleSubmitButton(false);
                setTimeout(hideStatus, 8000);
            }
        });
    </script>
</body>
</html>
